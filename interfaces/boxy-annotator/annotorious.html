<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotorious Annotator</title>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@5.0/build/openseadragon/openseadragon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@annotorious/openseadragon@latest/dist/annotorious-openseadragon.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@annotorious/openseadragon@latest/dist/annotorious-openseadragon.css">

    <style>
      #annotator-container {
        height:  100vh;
      }
    </style>

    <!-- <script type="module" src="../components/boxy-annotator/index.js"></script> -->
  </head>
  <body>
    <div id="annotator-container">

    </div>
    <script>
      window.onload = function() {
        // Full example, may be a bit extra
        // let viewer = OpenSeadragon({
        //   element: document.getElementById('annotator-container'),
        //   tileSources: {
        //    "@context":"http://iiif.io/api/image/3/context.json",
        //    "id":"https://iiif.io/api/image/3.0/example/reference/15f769d62ca9a3a2deca390efed75d73-3_titlepage1",
        //    "height":7230,
        //    "width":5428,
        //    "profile":"level1",
        //    "protocol":"http://iiif.io/api/image",
        //    "tiles":[
        //       {
        //          "height":512,
        //          "scaleFactors":[
        //             1,
        //             2,
        //             4,
        //             8
        //          ],
        //          "width":512
        //       }
        //    ]
        //   }
        // })

        // https://annotorious.dev/guides/openseadragon-iiif/
        // with this cannot use 'https://iiif.io/api/image/3.0/example/reference/15f769d62ca9a3a2deca390efed75d73-3_titlepage1/'
       let viewer = OpenSeadragon({
          element: document.getElementById('annotator-container'),
          tileSources: {
            type: 'image',
            url: 'https://iiif.io/api/image/3.0/example/reference/15f769d62ca9a3a2deca390efed75d73-3_titlepage1/full/max/0/default.jpg'
          }
        })

        // https://annotorious.dev/api-reference/openseadragon-annotator/
        // let anno = OpenSeadragon.Annotorious(viewer);
        let anno = AnnotoriousOSD.createOSDAnnotator(viewer, {
          adapter: AnnotoriousOSD.W3CImageFormat('https://iiif.io/api/image/3.0/example/reference/15f769d62ca9a3a2deca390efed75d73-3_titlepage1/full/max/0/default.jpg'),
          drawingEnabled: true,
          drawingMode: "drag",
          // https://annotorious.dev/api-reference/drawing-style/
          style: {
           fill: "#ff0000",
           fillOpacity: 0.25
          },
          userSelectAction: "EDIT"
          // EXAMPLE: Only allow me to edit my own annotations
          // userSelectAction: (annotation) => {
          //   const isMe = annotation.target.creator?.id === 'aboutgeo';
          //   return isMe ? 'EDIT' : 'SELECT';
          // }

        })

        // Listeners for Annotorious Annotation interactions.  We can add TPEN Services interactions here.

        // Need to implement the Line Chopper UI on an existing 'column designation' on existing Annotations in the UI.
        anno.on('clickAnnotation', (annotation, originalEvent) => {
          console.log('Annotation clicked: ' + annotation.id);
        })

        anno.on('mouseEnterAnnotation', (annotation) => {
          console.log('Mouse entered: ' + annotation.id)
        })

        /**
          * Fired when the set of selected annotation changes. For future compatibility, the argument is an array. 
          * However, only single annotation will be returned currently.
          * When the user de-selects an annotation, the event will be fired with an empty array.
        */
        anno.on('selectionChanged', (annotations) => {
          console.log('Selected annotations', annotations)
        })

        /**
          * Fired when the set of annotations visible in the current viewport changes.
          * This event is only available on the OpenSeadragonAnnotator and will respond to zooming and panning 
          * of the OpenSeadragon image.
        */
        anno.on('viewportIntersect', (annotations) => {
          console.log('Annotations in viewport', annotations)
        })

        anno.on('mouseLeaveAnnotation', (annotation) => {
          console.log('Mouse left: ' + annotation.id)
        })
        
        anno.on('createAnnotation', function(annotation) {
          console.log('Annotation Created:', annotation)
        })

        /**
         * Fired when an existing annotation is modified. Provides both the updated annotation and the previous state
         * of the annotation.
        */
        anno.on('updateAnnotation', (annotation, previous) => {
          console.log('Annotation before upate: ' + previous)
          console.log('Annotation after update: ' + annotation)
        })

        anno.on('deleteAnnotation', (annotation) => {
          console.log('Annotation Deleted:', annotation)
        })

        // Load existing Annotations.  Not sure of the AnnotationPage. Not sure about Content Negotiation yet.
        // anno.loadAnnotations('./annotations.json');
      }
    </script>
  </body>
</html>